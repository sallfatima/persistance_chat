# ğŸ”„ DIAGRAMMES DE SÃ‰QUENCE - FLUX CRITIQUES

## ğŸ“‹ TABLE DES MATIÃˆRES

1. [Flux GÃ©nÃ©ration Standard](#gÃ©nÃ©ration-standard)
2. [Flux RafraÃ®chissement (F5)](#rafraÃ®chissement-f5)
3. [Flux Cache Hit (Redis)](#cache-hit-redis)
4. [Flux Crash Recovery (Temporal)](#crash-recovery-temporal)

---

## ğŸŸ¢ SOLUTION MVP - Flux de GÃ©nÃ©ration Standard

### Diagramme de SÃ©quence Complet

```
User          Frontend        Backend         OpenAI          Files
Browser      (Chainlit)     (FastAPI)         API         (storage/)
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚  "Hello AI"  â”‚              â”‚               â”‚               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ POST /api/chat/generate      â”‚               â”‚
  â”‚              â”‚ {prompt: "Hello AI"}         â”‚               â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ task_id = uuid()              â”‚
  â”‚              â”‚              â”‚ = "abc-123"   â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ save_task_state()             â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ abc-123_state.json
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ {task_id: "abc-123"}         â”‚               â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ asyncio.create_task(          â”‚
  â”‚              â”‚              â”‚   stream_openai()             â”‚
  â”‚              â”‚              â”‚ )              â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚  msg object  â”‚              â”‚               â”‚               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ START POLLING LOOP (0.2s)    â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ GET /api/chat/chunks/abc-123?from_id=0       â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ get_chunks("abc-123", 0)      â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚ []  (empty)   â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ {chunks: []} â”‚               â”‚               â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ [WAIT 0.2s]  â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ [ASYNC TASK]  â”‚               â”‚
  â”‚              â”‚              â”‚ stream_openai()               â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
  â”‚              â”‚              â”‚ POST /v1/chat/completions     â”‚
  â”‚              â”‚              â”‚ stream=True   â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚              â”‚              â”‚ chunk: "Hello"â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ save_chunk("abc-123", 0, "Hello")
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ abc-123_chunks.json
  â”‚              â”‚              â”‚               â”‚ [              â”‚
  â”‚              â”‚              â”‚               â”‚   {id:0, text:"Hello"}
  â”‚              â”‚              â”‚               â”‚ ]              â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚              â”‚              â”‚ chunk: " there"               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ save_chunk("abc-123", 1, " there")
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ abc-123_chunks.json
  â”‚              â”‚              â”‚               â”‚ [              â”‚
  â”‚              â”‚              â”‚               â”‚   {id:0, text:"Hello"},
  â”‚              â”‚              â”‚               â”‚   {id:1, text:" there"}
  â”‚              â”‚              â”‚               â”‚ ]              â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ GET /api/chat/chunks/abc-123?from_id=0       â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ get_chunks("abc-123", 0)      â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚ [{id:0,"Hello"},{id:1," there"}]
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ {chunks: [...]}              â”‚               â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚  "Hello"     â”‚              â”‚               â”‚               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚
  â”‚  " there"    â”‚              â”‚               â”‚               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ [from_id=2]  â”‚               â”‚               â”‚
  â”‚              â”‚ [WAIT 0.2s]  â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚              â”‚              â”‚ chunk: "!"    â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ save_chunk("abc-123", 2, "!")
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚              â”‚              â”‚ [STREAM END]  â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ update_task_state("completed")â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ GET /api/chat/chunks/abc-123?from_id=2       â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ get_chunks()  â”‚               â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚ [{id:2,"!"}]  â”‚               â”‚
  â”‚              â”‚ {chunks: []}â”‚               â”‚               â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚  "!"         â”‚              â”‚               â”‚               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ GET /api/chat/status/abc-123â”‚               â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ get_task_state()              â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚ {status:"completed"}          â”‚
  â”‚              â”‚ {status:"completed"}         â”‚               â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚              â”‚ [STOP POLLING]               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚
  â”‚  âœ… Done     â”‚              â”‚               â”‚               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚
```

**â±ï¸ Timeline:**
- T+0.0s: User envoie message
- T+0.1s: Task crÃ©Ã©e, polling dÃ©marre
- T+0.5s: Premier chunk arrive
- T+1.0s: Frontend affiche "Hello"
- T+2.0s: Frontend affiche " there"
- T+3.0s: Frontend affiche "!"
- T+3.1s: GÃ©nÃ©ration terminÃ©e

---

## ğŸŸ¢ SOLUTION MVP - Flux RafraÃ®chissement (F5)

### ScÃ©nario: User appuie F5 pendant gÃ©nÃ©ration

```
User          Frontend        Backend         Files
Browser      (Chainlit)     (FastAPI)      (storage/)
  â”‚              â”‚              â”‚               â”‚
  â”‚ [PENDANT GÃ‰NÃ‰RATION EN COURS]               â”‚
  â”‚ task_id="abc-123"           â”‚               â”‚
  â”‚ 50% des chunks reÃ§us        â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚   F5 !!! ğŸ”„ â”‚              â”‚               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              âŒ FRONTEND RESET              â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚ Perd task_id â”‚               â”‚
  â”‚              â”‚ Perd Ã©tat    â”‚               â”‚
  â”‚              â”‚ Perd chunks  â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚ [PAGE RELOAD]â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚
  â”‚ Nouvelle pageâ”‚              â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚ [PENDANT CE TEMPS]
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚ Backend continue !
  â”‚              â”‚              â”‚ Chunks 50-100 gÃ©nÃ©rÃ©s
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚ save_chunk(50)â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚ save_chunk(51)â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚ ...           â”‚
  â”‚              â”‚              â”‚ save_chunk(100)
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚ COMPLETED âœ…  â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  âš ï¸  PROBLÃˆME: Comment rÃ©cupÃ©rer task_id="abc-123" ?
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚ OPTION A: User re-tape MÃŠME message         â”‚
  â”‚ "Hello AI"   â”‚              â”‚               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚               â”‚
  â”‚              â”‚ POST /api/chat/generate      â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚ âŒ CrÃ©e NOUVELLE tÃ¢che
  â”‚              â”‚              â”‚ task_id="def-456"
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚ âŒ RE-GÃ‰NÃˆRE tout
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚ OPTION B: Stocker task_id dans URL          â”‚
  â”‚ http://localhost:8501?task=abc-123          â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚ RÃ©cupÃ¨re task_id             â”‚
  â”‚              â”‚ = "abc-123"  â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚ GET /api/chat/chunks/abc-123â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
  â”‚              â”‚              â”‚ get_chunks()  â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚ ALL 100 chunksâ”‚
  â”‚              â”‚ {chunks: [...100...]}        â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚  "Hello there!"             â”‚               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚
  â”‚  [ALL TEXT INSTANTLY]       â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚
  â”‚              â”‚ âœ… RECOVERED â”‚               â”‚
```

**âŒ LIMITATION MVP:**
- Pas de mÃ©canisme automatique pour rÃ©cupÃ©rer task_id aprÃ¨s F5
- NÃ©cessite implÃ©mentation URL routing ou localStorage
- Ou user doit re-demander

---

## ğŸ”´ SOLUTION REDIS - Flux Cache Hit

### ScÃ©nario: User demande prompt identique 2Ã¨me fois

```
User          Frontend        Backend         Redis         PostgreSQL    OpenAI
Browser      (Chainlit)     (FastAPI)       (Cache)           (DB)         API
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚ MESSAGE 1: "Explain AI"     â”‚               â”‚               â”‚            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚ POST /api/chat/generate      â”‚               â”‚            â”‚
  â”‚              â”‚ {prompt:"Explain AI"}        â”‚               â”‚            â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ cache_key = sha256(          â”‚            â”‚
  â”‚              â”‚              â”‚   "Explain AI:openai:gpt-4o" â”‚            â”‚
  â”‚              â”‚              â”‚ )             â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ = "7a3f2b..." â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ GET "chat:cache:7a3f2b..."    â”‚            â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚            â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚            â”‚
  â”‚              â”‚              â”‚ None âŒ       â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ CACHE MISS    â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ task_id="abc-123"             â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ INSERT task   â”‚               â”‚            â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
  â”‚              â”‚              â”‚ (cached=0)    â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚ {task_id:"abc-123", cached:false}            â”‚            â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚  ğŸ†• badge    â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ [ASYNC] generate_with_cache   â”‚            â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚               â”‚ POST /v1/chat
  â”‚              â”‚              â”‚               â”‚               â”‚ stream=True
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚ chunk: "AI is..."             â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ INSERT chunk  â”‚               â”‚            â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚ chunk: " artificial..."       â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ ... [continue]                â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚ [STREAM END]  â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ full_response = "AI is artificial..."     â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ â­ SAVE TO REDIS CACHE                     â”‚
  â”‚              â”‚              â”‚ SETEX "chat:cache:7a3f2b..." 3600 {...}   â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚ TTL = 1 hour  â”‚            â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚            â”‚
  â”‚              â”‚              â”‚ OK âœ…         â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚ [Frontend displays chunks via polling]       â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚  âœ… Done     â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚  â±ï¸ 8 sec    â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚  ğŸ’° $0.02    â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5 MINUTES PASSENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚ MESSAGE 2: "Explain AI" (IDENTIQUE !)       â”‚               â”‚            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚ POST /api/chat/generate      â”‚               â”‚            â”‚
  â”‚              â”‚ {prompt:"Explain AI"}        â”‚               â”‚            â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ cache_key = sha256(          â”‚            â”‚
  â”‚              â”‚              â”‚   "Explain AI:openai:gpt-4o" â”‚            â”‚
  â”‚              â”‚              â”‚ )             â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ = "7a3f2b..." â”‚ (MÃŠME HASH !) â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ GET "chat:cache:7a3f2b..."    â”‚            â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚            â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚            â”‚
  â”‚              â”‚              â”‚ {             â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚   full_response:"AI is...",   â”‚            â”‚
  â”‚              â”‚              â”‚   provider:"openai",          â”‚            â”‚
  â”‚              â”‚              â”‚   model:"gpt-4o"              â”‚            â”‚
  â”‚              â”‚              â”‚ }             â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ ğŸ¯ CACHE HIT !                â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ task_id="def-456"             â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ INSERT task   â”‚               â”‚            â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
  â”‚              â”‚              â”‚ (cached=1) â­                 â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ Split full_response into chunks           â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ INSERT chunks â”‚               â”‚            â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
  â”‚              â”‚              â”‚ (all at once) â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚ {task_id:"def-456", cached:true, status:"completed"}      â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚  ğŸ¯ CACHE HIT badge         â”‚               â”‚               â”‚            â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚ GET /api/chat/chunks/def-456â”‚               â”‚            â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚ SELECT chunks â”‚               â”‚            â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
  â”‚              â”‚              â”‚ [ALL CHUNKS]  â”‚               â”‚            â”‚
  â”‚              â”‚ {chunks:[...ALL...]}         â”‚               â”‚            â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚  "AI is artificial intelligence..."         â”‚               â”‚            â”‚
  â”‚  [DISPLAY ALL INSTANTLY]    â”‚               â”‚               â”‚            â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚  âœ… Done     â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚  â±ï¸ 0.5 sec  â”‚  (vs 8 sec)  â”‚               â”‚               â”‚            â”‚
  â”‚  ğŸ’° $0.00    â”‚  (vs $0.02)  â”‚               â”‚               â”‚            â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚            â”‚
  â”‚ ğŸ’¡ Ã‰conomie: 7.5 secondes + $0.02          â”‚               â”‚            â”‚
```

**âœ… AVANTAGES CACHE:**
- 16x plus rapide (0.5s vs 8s)
- 100% Ã©conomie LLM
- Fonctionne pour EXACT mÃªme prompt

---

## ğŸŸ£ SOLUTION TEMPORAL - Flux Crash Recovery

### ScÃ©nario: Worker crash Ã  47% de gÃ©nÃ©ration

```
User          Frontend        Backend         Temporal        Worker        PostgreSQL
Browser      (Chainlit)     (FastAPI)        Server         Process         (Events)
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚ "Write essay"â”‚              â”‚               â”‚               â”‚               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚ POST /api/workflows/start    â”‚               â”‚               â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ workflow_id = "chat-abc-123"  â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚ client.start_workflow(        â”‚               â”‚
  â”‚              â”‚              â”‚   ChatStreamingWorkflow.run   â”‚               â”‚
  â”‚              â”‚              â”‚ )             â”‚               â”‚               â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT execution              â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ (id:"chat-abc-123")           â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ (WORKFLOW_STARTED)            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ Add task to queue             â”‚
  â”‚              â”‚              â”‚               â”‚ "chat-queue"  â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
  â”‚              â”‚              â”‚ {workflow_id:"chat-abc-123"}  â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚ {workflow_id:"chat-abc-123"} â”‚               â”‚               â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚              â”‚              â”‚               â”‚ Worker polls  â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ "chat-queue"  â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ Task received â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ "chat-abc-123"â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ Start workflowâ”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ execution     â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ Ã‰TAPE 1: VALIDATION      â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ execute_activity(        â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚   validate_prompt        â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ )                        â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ â†’ return True            â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ (ACTIVITY_COMPLETED)          â”‚
  â”‚              â”‚              â”‚               â”‚ â­ CHECKPOINT 1              â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ Ã‰TAPE 2: GÃ‰NÃ‰RATION LLM  â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ execute_activity(        â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚   generate_full_text...  â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ )                        â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ [Call OpenAI API]        â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ [Takes 8 seconds]        â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ â†’ return full_text       â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚   "AI is..." [2000 words]â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ (ACTIVITY_COMPLETED)          â”‚
  â”‚              â”‚              â”‚               â”‚ result: "AI is..." [full]     â”‚
  â”‚              â”‚              â”‚               â”‚ â­ CHECKPOINT 2 - CRITIQUE ! â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ Ã‰TAPE 3: CHUNKING        â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ chunks = split(full_text)â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ â†’ 100 chunks             â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ Ã‰TAPE 4: SAVE CHUNKS     â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ FOR i in range(100):     â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚                          â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚   save_chunk(i)          â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ execute_activity(save_chunk_0)â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ (ACTIVITY_COMPLETED)          â”‚
  â”‚              â”‚              â”‚               â”‚ â­ CHECKPOINT 3.0            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ execute_activity(save_chunk_1)â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ (ACTIVITY_COMPLETED)          â”‚
  â”‚              â”‚              â”‚               â”‚ â­ CHECKPOINT 3.1            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ ... [continue]                â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ execute_activity(save_chunk_46)
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ â­ CHECKPOINT 3.46           â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ execute_activity(save_chunk_47)
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ â­ CHECKPOINT 3.47           â”‚
  â”‚              â”‚              â”‚               â”‚ ğŸ’¾ Ã‰TAT SAUVEGARDÃ‰:         â”‚
  â”‚              â”‚              â”‚               â”‚    â€¢ Validation âœ“            â”‚
  â”‚              â”‚              â”‚               â”‚    â€¢ LLM gen âœ“               â”‚
  â”‚              â”‚              â”‚               â”‚    â€¢ Chunks 0-47 âœ“           â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ ğŸ’¥ WORKER CRASH !            â”‚
  â”‚              â”‚              â”‚               â”‚               âŒ              â”‚
  â”‚              â”‚              â”‚               â”‚               [DEAD]          â”‚
  â”‚              â”‚              â”‚               â”‚                               â”‚
  â”‚              â”‚              â”‚               â”‚                               â”‚
  â”‚              â”‚ [Frontend continue polling]  â”‚                               â”‚
  â”‚              â”‚ GET /api/workflows/.../statusâ”‚                               â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚                               â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                               â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                               â”‚
  â”‚              â”‚              â”‚ {status:"running", progress:47}               â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚                               â”‚
  â”‚              â”‚              â”‚               â”‚                               â”‚
  â”‚  "Generation en cours... 47%"               â”‚                               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚                               â”‚
  â”‚              â”‚              â”‚               â”‚                               â”‚
  â”‚              â”‚              â”‚               â”‚                               â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 30 SECONDES PASSENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
  â”‚              â”‚              â”‚               â”‚                               â”‚
  â”‚              â”‚              â”‚               â”‚                               â”‚
  â”‚              â”‚              â”‚               â”‚ ğŸ”„ WORKER RESTART            â”‚
  â”‚              â”‚              â”‚               â”‚               âœ…              â”‚
  â”‚              â”‚              â”‚               â”‚               [ALIVE]         â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚              â”‚              â”‚               â”‚ Worker connects               â”‚
  â”‚              â”‚              â”‚               â”‚ Polls "chat-queue"            â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ Detects incomplete            â”‚
  â”‚              â”‚              â”‚               â”‚ workflow "chat-abc-123"       â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ SELECT history_events         â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ WHERE workflow_id=...         â”‚
  â”‚              â”‚              â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚              â”‚              â”‚               â”‚ [                             â”‚
  â”‚              â”‚              â”‚               â”‚   Event 1: WORKFLOW_STARTED,  â”‚
  â”‚              â”‚              â”‚               â”‚   Event 3: validate âœ“,        â”‚
  â”‚              â”‚              â”‚               â”‚   Event 5: generate âœ“ â­,     â”‚
  â”‚              â”‚              â”‚               â”‚   Event 6-53: save_chunk 0-47âœ“â”‚
  â”‚              â”‚              â”‚               â”‚ ]                             â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ â­ REPLAY WORKFLOW           â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ Reconstruct state:            â”‚
  â”‚              â”‚              â”‚               â”‚ â€¢ Skip validate (done)        â”‚
  â”‚              â”‚              â”‚               â”‚ â€¢ Skip generate (done)        â”‚
  â”‚              â”‚              â”‚               â”‚   full_text = Event 5.result  â”‚
  â”‚              â”‚              â”‚               â”‚ â€¢ Skip save_chunk 0-47 (done) â”‚
  â”‚              â”‚              â”‚               â”‚ â€¢ Resume at save_chunk(48)    â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚              â”‚              â”‚               â”‚ â”‚ CONTINUE FROM CHUNK 48   â”‚  â”‚
  â”‚              â”‚              â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ execute_activity(save_chunk_48)
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ â­ CHECKPOINT 3.48           â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ ... [continue 49-99]          â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ execute_activity(save_chunk_99)
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ â­ CHECKPOINT 3.99           â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ INSERT history_event          â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ (WORKFLOW_COMPLETED)          â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚ UPDATE execution              â”‚
  â”‚              â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚              â”‚              â”‚               â”‚ SET status="completed"        â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚ GET /api/workflows/.../statusâ”‚               â”‚               â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
  â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
  â”‚              â”‚              â”‚ {status:"completed", progress:100}            â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚  âœ… "Workflow terminÃ© !"    â”‚               â”‚               â”‚               â”‚
  â”‚  ğŸ“Š Voir Temporal UI        â”‚               â”‚               â”‚               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚              â”‚              â”‚               â”‚               â”‚               â”‚
  â”‚ ğŸ’¡ RÃ‰SULTAT:                â”‚               â”‚               â”‚               â”‚
  â”‚ â€¢ Chunks 0-47: PrÃ©servÃ©s âœ“  â”‚               â”‚               â”‚               â”‚
  â”‚ â€¢ Chunks 48-99: GÃ©nÃ©rÃ©s aprÃ¨s restart âœ“     â”‚               â”‚               â”‚
  â”‚ â€¢ Pas de re-gÃ©nÃ©ration LLM âœ“                â”‚               â”‚               â”‚
  â”‚ â€¢ Ã‰conomie: $0.02 + 8 secondes âœ“            â”‚               â”‚               â”‚
  â”‚ â€¢ Zero data loss âœ“           â”‚               â”‚               â”‚               â”‚
```

**âœ… AVANTAGES TEMPORAL:**
- Reprend EXACTEMENT oÃ¹ il Ã©tait
- Pas de re-gÃ©nÃ©ration (Ã©conomie $$)
- Zero data loss
- Historique complet dans UI
- Retry automatique

---

## ğŸ“Š COMPARAISON TEMPS DE RÃ‰CUPÃ‰RATION

### MVP - AprÃ¨s F5

```
GÃ©nÃ©ration en cours (3 min)
   â”‚
   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 50%
   â”‚
   â–¼ F5
   â”‚
   âŒ Perd tout
   â”‚
   â”‚ User re-demande
   â”‚
   â–¼
   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
   â”‚
   â±ï¸ Total: 6 minutes (3 min perdu + 3 min nouveau)
   ğŸ’° Total: $0.04 (2x gÃ©nÃ©ration)
```

### Redis - AprÃ¨s Backend Crash

```
GÃ©nÃ©ration en cours (3 min)
   â”‚
   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 50%
   â”‚ Chunks 0-50 en PostgreSQL âœ“
   â”‚
   â–¼ Backend crash
   â”‚
   âš ï¸ GÃ©nÃ©ration arrÃªtÃ©e
   â”‚
   â”‚ Backend restart (30s)
   â”‚
   â”‚ âŒ Task perdue
   â”‚ âœ… Chunks 0-50 en DB
   â”‚
   â”‚ User re-demande
   â”‚
   â–¼
   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
   â”‚
   â±ï¸ Total: 6.5 minutes (3 min perdu + 0.5 min restart + 3 min nouveau)
   ğŸ’° Total: $0.04 (2x gÃ©nÃ©ration)
```

### Temporal - AprÃ¨s Worker Crash

```
GÃ©nÃ©ration en cours (3 min)
   â”‚
   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 50%
   â”‚ Checkpoint 0-50 dans Temporal âœ“
   â”‚
   â–¼ Worker crash
   â”‚
   â”‚ Workflow SUSPENDU (pas perdu)
   â”‚
   â”‚ Worker restart (30s)
   â”‚
   â”‚ â­ Workflow REPREND automatiquement
   â”‚ âœ… Skip chunks 0-50 (dÃ©jÃ  faits)
   â”‚ âœ… Continue chunks 51-100
   â”‚
   â–¼
   â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 51-100%
   â”‚
   â±ï¸ Total: 5 minutes (3 min gÃ©nÃ©ration + 0.5 min restart + 1.5 min finish)
   ğŸ’° Total: $0.02 (1x gÃ©nÃ©ration seulement)
   
   âœ… Ã‰conomie vs MVP/Redis:
      â€¢ -1.5 minutes (25% plus rapide)
      â€¢ -$0.02 (50% moins cher)
```

---

## ğŸ¯ CONCLUSION

### Garanties de Persistance

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ScÃ©nario                 â”‚   MVP   â”‚  Redis  â”‚  Temporal â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ F5 (rafraÃ®chir page)     â”‚    âš ï¸   â”‚   âš ï¸    â”‚     âœ…    â”‚
â”‚ Backend crash            â”‚    âŒ   â”‚   âš ï¸    â”‚     âœ…    â”‚
â”‚ Worker crash             â”‚   N/A   â”‚   N/A   â”‚     âœ…    â”‚
â”‚ Database crash           â”‚   N/A   â”‚   âŒ    â”‚     âœ…    â”‚
â”‚ Tout crash en mÃªme temps â”‚    âŒ   â”‚   âŒ    â”‚     âœ…    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Zero data loss           â”‚    âŒ   â”‚   âš ï¸    â”‚     âœ…    â”‚
â”‚ Avoid re-generation      â”‚    âŒ   â”‚   âŒ    â”‚     âœ…    â”‚
â”‚ Auto-recovery            â”‚    âŒ   â”‚   âŒ    â”‚     âœ…    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LÃ©gende:
âœ… Garanti
âš ï¸  Partiel
âŒ Non supportÃ©
```

**Pour vos besoins (tÃ¢ches longues + F5 + reprendre oÃ¹ on en Ã©tait):**

**â†’ ğŸŸ£ TEMPORAL est LA solution**

